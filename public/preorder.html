<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preorder · Shiny Credit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f5f3ef;
      --surface: #ffffff;
      --text: #1a1a1a;
      --text-muted: #5c5c5c;
      --accent: #0d6b5c;
      --accent-hover: #0a5548;
      --border: #e5e2dc;
      --error: #c23d3d;
      --radius: 12px;
      --shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }
    * { box-sizing: border-box; }
    body {
      font-family: "DM Sans", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      padding: 24px;
      line-height: 1.5;
    }
    .container { max-width: 900px; margin: 0 auto; }
    header { margin-bottom: 24px; }
    h1 { font-size: 1.5rem; font-weight: 700; margin: 0 0 4px 0; }
    .subtitle { font-size: 0.9375rem; color: var(--text-muted); margin: 0; }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 24px;
    }
    .actions { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 20px; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      font-family: inherit;
      font-size: 0.9375rem;
      font-weight: 600;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.2s, transform 0.15s;
    }
    .btn:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    .btn-secondary:hover:not(:disabled) { background: rgba(13, 107, 92, 0.08); }
    input[type="file"] { font-family: inherit; font-size: 0.875rem; }
    .table-wrap { overflow-x: auto; margin-top: 16px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); }
    th { font-weight: 600; color: var(--text); background: var(--bg); }
    tr:hover td { background: rgba(0,0,0,0.02); }
    .state-message {
      padding: 24px;
      text-align: center;
      color: var(--text-muted);
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      background: var(--surface);
    }
    .state-message.error { color: var(--error); border-color: rgba(194,61,61,0.3); background: rgba(194,61,61,0.06); }
    .state-message.success { color: var(--accent); border-color: rgba(13,107,92,0.3); background: rgba(13,107,92,0.06); }
    .feedback { margin-top: 16px; font-size: 0.9375rem; }
    .feedback.error { color: var(--error); }
    .feedback.success { color: var(--accent); }
    .loader {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 8px 0;
    }
    .loader-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      animation: bounce 0.6s ease-in-out infinite both;
    }
    .loader-dot:nth-child(1) { animation-delay: 0s; }
    .loader-dot:nth-child(2) { animation-delay: 0.1s; }
    .loader-dot:nth-child(3) { animation-delay: 0.2s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.6; }
      40% { transform: scale(1); opacity: 1; }
    }
    .hint { font-size: 0.8125rem; color: var(--text-muted); margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Preorder setup</h1>
      <p class="subtitle">Upload a sheet to set preorder metafields on product variants by SKU.</p>
    </header>

    <div class="card">
      <div class="actions">
        <input type="file" id="file" accept=".csv,text/csv,application/csv" />
        <button type="button" class="btn" id="apply" disabled>Apply to store</button>
        <a href="/" class="btn btn-secondary" id="back-link">Back to app</a>
      </div>
      <p class="hint">CSV columns: <strong>sku</strong>, <strong>is_preorder</strong> (true/false), <strong>preorder_limit</strong> (integer), <strong>preorder_message</strong>. First row = headers. SKU must match a variant in your store.</p>

      <div id="table-area"></div>
      <div id="feedback" class="feedback" role="status" aria-live="polite"></div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search)
    const shop = params.get("shop")

    if (shop) {
      document.getElementById("back-link").href = "/?shop=" + encodeURIComponent(shop)
    } else {
      document.getElementById("table-area").innerHTML =
        '<p class="state-message error">Open this page from the app so the URL includes <code>?shop=your-store.myshopify.com</code>.</p>'
      document.getElementById("file").disabled = true
    }

    let rows = []

    const fileInput = document.getElementById("file")
    const applyBtn = document.getElementById("apply")
    const tableArea = document.getElementById("table-area")
    const feedbackEl = document.getElementById("feedback")

    function setFeedback(msg, type) {
      feedbackEl.textContent = msg
      feedbackEl.className = "feedback " + (type || "")
    }

    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/)
      if (lines.length === 0) return []
      const header = lines[0].split(",").map((h) => h.trim().toLowerCase().replace(/\s+/g, "_"))
      const skuIdx = header.indexOf("sku")
      const preorderIdx = header.findIndex((h) => h === "is_preorder" || h === "is preorder")
      const limitIdx = header.findIndex((h) => h === "preorder_limit" || h === "preorder limit")
      const msgIdx = header.findIndex((h) => h === "preorder_message" || h === "preorder message")
      const cols = [skuIdx, preorderIdx, limitIdx, msgIdx]
      if (skuIdx === -1) return null

      const out = []
      for (let i = 1; i < lines.length; i++) {
        const cells = lines[i].split(",").map((c) => c.trim().replace(/^"|"$/g, ""))
        const sku = cells[skuIdx] ?? ""
        if (!sku) continue
        out.push({
          sku,
          is_preorder: preorderIdx >= 0 ? (cells[preorderIdx] ?? "true") : "true",
          preorder_limit: limitIdx >= 0 ? (cells[limitIdx] ?? "0") : "0",
          preorder_message: msgIdx >= 0 ? (cells[msgIdx] ?? "") : ""
        })
      }
      return out
    }

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0]
      tableArea.innerHTML = ""
      setFeedback("")
      applyBtn.disabled = true
      if (!file) return
      const reader = new FileReader()
      reader.onload = (e) => {
        const text = e.target?.result
        if (!text) return
        rows = parseCsv(String(text))
        if (rows === null) {
          setFeedback("CSV must have a 'sku' column.", "error")
          return
        }
        if (rows.length === 0) {
          setFeedback("No data rows found.", "error")
          return
        }
        renderTable(rows)
        applyBtn.disabled = false
        setFeedback(rows.length + " row(s) loaded. Click Apply to store to set preorder metafields.")
      }
      reader.readAsText(file, "UTF-8")
    })

    function escapeHtml(str) {
      const div = document.createElement("div")
      div.textContent = str
      return div.innerHTML
    }

    function renderTable(data) {
      const html = `
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>sku</th>
                <th>is_preorder</th>
                <th>preorder_limit</th>
                <th>preorder_message</th>
              </tr>
            </thead>
            <tbody>
              ${data.map((r) => `
                <tr>
                  <td>${escapeHtml(r.sku)}</td>
                  <td>${escapeHtml(String(r.is_preorder))}</td>
                  <td>${escapeHtml(String(r.preorder_limit))}</td>
                  <td>${escapeHtml(String(r.preorder_message))}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `
      tableArea.innerHTML = html
    }

    applyBtn.addEventListener("click", async () => {
      if (!shop) {
        setFeedback("Missing shop. Open this page from the app.", "error")
        return
      }
      if (rows.length === 0) return
      applyBtn.disabled = true
      setFeedback("")
      feedbackEl.innerHTML = '<span class="loader"><span class="loader-dot"></span><span class="loader-dot"></span><span class="loader-dot"></span></span> Applying…'

      try {
        const res = await fetch("/preorder/apply?shop=" + encodeURIComponent(shop), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ shop, rows })
        })
        const data = await res.json().catch(() => ({}))
        if (res.ok) {
          const storeCount = data.storeVariantSkusCount ?? 0
          const applied = data.applied ?? 0
          const skipped = data.skipped ?? 0
          let msg = "Done. Applied: " + applied + " variant(s)."
          if (storeCount === 0) {
            msg = "No variants with a SKU were found in your store. Add SKUs to your product variants in Shopify, then try again."
          } else if (applied === 0 && skipped > 0) {
            msg = "Store has " + storeCount + " variant(s) with SKU, but none matched your sheet. Check that your CSV SKUs match exactly (matching is case-insensitive). Skipped: " + skipped + " row(s)."
          } else if (skipped > 0) {
            msg += " Skipped (SKU not in store): " + skipped + ". "
          }
          if (data.errors?.length) msg += " Errors: " + data.errors.map((e) => e.message).join("; ")
          setFeedback(msg, data.success ? "success" : "error")
        } else {
          setFeedback(data.error || "Request failed", "error")
        }
      } catch (err) {
        setFeedback("Network error. Try again.", "error")
      }
      applyBtn.disabled = false
    })
  </script>
</body>
</html>
